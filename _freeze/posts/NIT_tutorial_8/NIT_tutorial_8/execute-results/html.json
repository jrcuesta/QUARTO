{
  "hash": "580f2f73fbf8842326bfd8ed6470638a",
  "result": {
    "markdown": "---\ntitle: \"PCA - NIT tutorial (part 8)\"\nauthor: \"José Ramón Cuesta\"\ndescription: \"Running Principal Components Analysis on the spectra matrix\"\nimage: biplot23.jpeg\ndate: \"2022-10-21\"\ncategories: [R, NIT Tutorial, PCA]\n---\n\n\nLet´s load the workspace and the libraries we are going to use:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"C:/BLOG/Workspaces/NIT Tutorial/NIT_ws7.RData\")\nlibrary(photobiology)\n```\n:::\n\n\n## Principal Component Analysis\n\nWe use the spectra matrix \"X\" and we want to decompose it into a matrix product:\n\n## **X = T.P^t^ + E**\n\nwhere:\n\n-   **X** is the spectra matrix (with the math treatment we have choose)\n\n-   **T** is a score matrix,\n\n-   **P** is the terms matrix and\n\n-   **E** is the error matrix.\n\nThere are several ways to calculate the PCA with R, but let´s start with \"prcomp\". For the calculation we will use the tecator spectra with the SNV+DT2 that we have seen on part 6.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntecator_pc <- prcomp(tecator$snvdt2der2_spec)\nsummary(tecator_pc)[[6]][,1:10]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                               PC1         PC2         PC3          PC4\nStandard deviation     0.004966548 0.001532207 0.000939981 0.0005106424\nProportion of Variance 0.869350000 0.082740000 0.031140000 0.0091900000\nCumulative Proportion  0.869350000 0.952090000 0.983230000 0.9924200000\n                                PC5         PC6         PC7          PC8\nStandard deviation     0.0003223387 0.000200553 0.000164743 0.0001470434\nProportion of Variance 0.0036600000 0.001420000 0.000960000 0.0007600000\nCumulative Proportion  0.9960800000 0.997500000 0.998460000 0.9992200000\n                                PC9         PC10\nStandard deviation     0.0001073009 6.183104e-05\nProportion of Variance 0.0004100000 1.300000e-04\nCumulative Proportion  0.9996200000 9.997600e-01\n```\n:::\n:::\n\n\nIn the summary we can see the quantity of variance explained by every term (or principal component). We can calculate the variance in percentage and plot it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npercentVariance <- round(tecator_pc$sdev^2/sum(tecator_pc$sdev^2)*100, 2)\n```\n:::\n\n\n@fig-expvar_pc *shows how the firsts PCs explain almost all the variance, so we can discard the rest and retain only the important ones.*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(percentVariance[1:10], type = \"b\", xlab = \"PC number\", ylab= \"% Variance explained\")\n```\n\n::: {.cell-output-display}\n![Percentage Variance explained by PC](NIT_tutorial_8_files/figure-html/fig-expvar_pc-1.png){#fig-expvar_pc width=672}\n:::\n:::\n\n\n@fig-expvar_pc *The plot of the cumulative variance can give us a better idea about the number of principal components to keep:*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(cumsum(tecator_pc$sdev^2 / sum(tecator_pc$sdev^2)*100)[1:10], type=\"b\", xlab = \"PC number\", ylab = \"Cummulative Variance %\")\n```\n\n::: {.cell-output-display}\n![Cumulative variance as we add a new PC](NIT_tutorial_8_files/figure-html/fig-cumvar_pc-1.png){#fig-cumvar_pc width=672}\n:::\n:::\n\n\nAs we see, after 6 principal components the line becomes flat and almost 100% of the variance is explained (exactly 99.75 %). We see how the first one explain almost 87% of the variance, and the two first terms explain together more than 95% of the variance. For this reason is interesting to look to the plane formed by this two terms and see the scores. We can see this using \"biplot\".\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbiplot(tecator_pc)\n```\n\n::: {.cell-output-display}\n![Biplot with scores and loadings for PC1 vs PC2](NIT_tutorial_8_files/figure-html/fig-biplot12-1.png){#fig-biplot12 width=672}\n:::\n:::\n\n\n@fig-biplot12 *We see the samples as a black number in the plane, and the scores are the projection of those samples on the low axis (PC1), and left axis (PC2). The loadings are expressed as red arrow, and their projections must be done over the bottom and right axis. As we can see in the biplot of PC1 and PC2, the wavelengths between 922 and 936 have a high negative loading value for PC1, but very low for PC2.*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmatplot(seq(850, 1048, by = 2), tecator_pc$rotation[ , 1:2], type = \"l\", ylab = \"\", xlab = \"wavelength\", main = \"Loadings 1 and 2\", \n        col = c(\"black\", \"red\"))\nabline(h = 0)\nrect(xleft = 922, xright = 936, ybottom = -0.38, ytop = 0.21, border = \"blue\", lty = \"dashed\", lwd = 2 )\nlegend(\"topright\", legend = c(\"1st loading\", \"2nd loading\"), lty = c(1, 2), col = c(\"black\", \"red\"))\n```\n\n::: {.cell-output-display}\n![Loadings 1 and 2](NIT_tutorial_8_files/figure-html/fig-loadings12-1.png){#fig-loadings12 width=672}\n:::\n:::\n\n\n@fig-loadings12 *All those arrows in the plane that we call loadings (100 values, one for each wavelength), can be seen better as a spectrum where we see peaks and valleys that give details about the importance of every wavelength in the Principal Component. We show the area between 922 and 936 that we have been talking about.*\n\nLet´s see now the biplot for PC2 and PC3\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbiplot(tecator_pc, choices = 2:3)\n```\n\n::: {.cell-output-display}\n![Biplot with scores and loadings for PC2 vs PC3](NIT_tutorial_8_files/figure-html/fig-biplot23-1.png){#fig-biplot23 width=672}\n:::\n:::\n\n\n@fig-biplot23 In the case of the plane formed by PC2 and PC3, we can see how the loadings go in almost all the directions in the plane. We can see also how some samples seems to be apart from the rest.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmatplot(seq(850, 1048, by = 2), tecator_pc$rotation[ , 2:3], type = \"l\", ylab = \"\", xlab = \"wavelength\", main = \"Loadings 2 and 3\", col = c(\"red\", \"blue\"))\nlegend(\"topright\", legend = c(\"2nd loading\", \"3th loading\"), lty = c(1, 2), col = c(\"red\", \"blue\"))\n```\n\n::: {.cell-output-display}\n![Loadings 2 and 3](NIT_tutorial_8_files/figure-html/fig-loadings23-1.png){#fig-loadings23 width=672}\n:::\n:::\n\n\nLooking to the \"biplots\" and the \"loadings\" we have a better idea of the importance of every wavelength to the correspondent principal component.\n\n## How to find the peaks in the loading spectrum?\n\nWe can use the package {photobiology} and the function valleys for the negative peaks and find_peaks for the positive ones, doing this we can study the loadings in more detail and check if they have certain degree of relationship with the outcome variables (parameters).\n\nLet´s have a look to the first loading (peaks and valleys), trying to find out what explain:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmatplot(seq(850, 1048, by = 2), tecator_pc$rotation[ , 1], type = \"l\", ylab = \"\", xlab = \"wavelength\", main = \"Loading 1\", col = \"black\")\n\nwhich(find_peaks(tecator_pc$rotation[ ,1]) == TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n 854  858  878  906  948  988 1002 1028 \n   3    5   15   29   50   70   77   90 \n```\n:::\n\n```{.r .cell-code}\nvalleys(tecator_pc$rotation[ , 1])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         892          930          972          998         1018         1036 \n-0.003496019 -0.359915187  0.023924714  0.031066416 -0.026031653 -0.045698228 \n```\n:::\n\n```{.r .cell-code}\nabline(v = c(878, 906, 948, 1028), col = \"blue\")\nabline(v = c(892, 930, 972, 1018), col = \"green\")\n\nlegend(\"bottomleft\", legend = c(\"930....FAT\", \"948....WATER\"), lty = 1, col = c(\"green\", \"black\"))\nrect(xleft = 925, xright = 960, ybottom = -0.38, ytop = 0.21, border = \"red\", lty = \"dashed\", lwd = 2 )\n```\n\n::: {.cell-output-display}\n![Interpret loadings 1 and 2 bands](NIT_tutorial_8_files/figure-html/fig-loadings12bands-1.png){#fig-loadings12bands width=672}\n:::\n:::\n\n\nBy the literature we can know where the overtones for certain bonds like C_H, O_H or N-H are. And looking to the first loading, it seems that represents in certain way, the fat and moisture parameter. We just have to correlate the loadigs values for the first PC with the three parameters and see the high correlation with fat and moisture.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncor(tecator$Moisture, tecator_pc$x[ , 1])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] -0.9777829\n```\n:::\n\n```{.r .cell-code}\ncor(tecator$Fat, tecator_pc$x[ , 1])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.9823003\n```\n:::\n\n```{.r .cell-code}\ncor(tecator$Protein, tecator_pc$x[ , 1])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] -0.829764\n```\n:::\n:::\n\n\nAs we have seen in previous posts fat and protein are inverse correlated, and that is the reason we have a negative high correlation for the protein with this first loading.\n\nWe can see the XY plots for the reference values vs. the first loading values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(tecator$Moisture, tecator_pc$x[ , 1], xlab = \"Moisture\", ylab = \"PC1  response\", main = \"Moisture vs PC1\")\n```\n\n::: {.cell-output-display}\n![correlating Moisture with scores for loading 1](NIT_tutorial_8_files/figure-html/fig-PC1vsMOI-1.png){#fig-PC1vsMOI width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(tecator$Fat, tecator_pc$x[ , 1], xlab = \"Fat\", ylab = \"First loading response\", main = \"Fat vs PC1\")\n```\n\n::: {.cell-output-display}\n![correlating Fat with scores for loading 1](NIT_tutorial_8_files/figure-html/fig-PC1vsFAT-1.png){#fig-PC1vsFAT width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(tecator$Protein, tecator_pc$x[ , 1], xlab = \"Protein\", ylab = \"First loading response\", main = \"Protein vs PC1\")\n```\n\n::: {.cell-output-display}\n![correlating Protein with scores for loading 1](NIT_tutorial_8_files/figure-html/fig-PC1vsPROT-1.png){#fig-PC1vsPROT width=672}\n:::\n:::\n\n\nAs we study more loadings we still see the bands which correspond to fat, water or protein, but the correlation with the reference values is less, but this is normal due that the highest was taken away by the first principal component and we are extracting from the remaining new variability that we want to interpret.\n\nAs we see, there is certain correlation between the PC loadings and the parameters, so we can develop a regression called \"principal components regression\" to predict the values of new samples. So this is something we can do in coming posts.\n",
    "supporting": [
      "NIT_tutorial_8_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}