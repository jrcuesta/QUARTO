{
  "hash": "62a4198fd001810c205debd31e0ff6fb",
  "result": {
    "markdown": "---\ntitle: \"Near Infrared Transmitance Tutorial (part 7)\"\ndescription: \"We can use derivatives to remove baseline offsets, alone or combined with other scatter math treatments\"\nimage: cor_spectra_der.jpeg\nauthor: \"José Ramón Cuesta\"\ndraft: FALSE\ndate: \"2022-10-19\"\ncategories: [R, NIT Tutorial, Removing scatter, Math-treatments]\n---\n\n\nLet´s start by loading our workspace and the libraries we will use in this post:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"C:/BLOG/Workspaces/NIT Tutorial/NIT_ws6.RData\")\nlibrary(tidyverse)\nlibrary(prospectr)\npar(mar=c(5,4,4,2)+0.1)\n```\n:::\n\n\nWe have seen some of the most popular scatter correction methods in the previous posts, and now, in this one, we will try the derivatives (first and second) alone and combined with SNV and the quadratic detrend.\n\n## First Derivative\n\nWe are use to see peaks and try to see at which wavelengths are the peaks and find out what type of bonds absorb at those wavelengths. Of course in the NIR bands, due to they are quite broad bands, the peaks are not so sharp as we would like to see them (like in the middle infrared), and everything became even worse as they combine with other neighbors bands forming overlapping bands even broader.\n\nThe derivatives improve the resolution, increasing the separation of the overlaping bands, but the cost is the difficulty to interpret them. In the case of the first derivative, the peak maximum change to a zero-crossing. Let´s use the {prospectr} package to calculate the first derivative of the meat raw spectra: The fuction we use is gapDer, where:\n\n-   **X** = the raw spectra matrix (we could use absorp or tecator\\$spec)\n\n-   **m** = order of the derivative (for the first derivative we use 1)\n\n-   **w** = gap size (we will use 1)\n\n-   **s** = segment size (space on both sides of the gap to average the absorbance values)\n\n-   **delta.wav** = interval between data points (2 in this case)\n\nLet´s calculate the first derivative alone and the combination of SNV and Detrend plus the first derivative:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#First derivative calculation\nder1_spec <- gapDer(absorp, m = 1, w = 5, s = 1, delta.wav = 2)\n#SNV and Detrend2 plus First Derivative\nsnvdt2der1_spec <- gapDer(tecator$sndt2_spec, m = 1, w = 5, s = 1, delta.wav = 2)\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n@fig-SNVDT2_1der compares the spectra treated with SNV plus Quadratic Detrend with the spectra of just the first derivative.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmatplot(colnames(tecator$sndt2_spec), t(tecator$sndt2_spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"SNVDT2 vs 1º Der\", col = \"black\", xaxt = \"n\")\npar(new=TRUE)\nmatplot(colnames(der1_spec), t(der1_spec), type = \"l\",lty = 4,axes = FALSE, xlab = \" \", ylab = \" \", main = \" \", col = \"red\", bty = \"n\")\naxis(4)\naxis(1)\n```\n\n::: {.cell-output-display}\n![SNVDT2 and First derivative compared](NIT_tutorial_7_files/figure-html/fig-SNVDT2_1der-1.png){#fig-SNVDT2_1der width=672}\n:::\n:::\n\n\n@fig-SNVDT2_SNVDT21der compares the spectra treated with SNV plus Quadratic Detrend with the first derivative applied to the SNV+DT2 spectra.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmatplot(colnames(tecator$sndt2_spec), t(tecator$sndt2_spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"SNVDT2 vs SNVDT2 + 1º Der\", col = \"black\", xaxt = \"n\")\npar(new=TRUE)\nmatplot(colnames(snvdt2der1_spec), t(snvdt2der1_spec), type = \"l\",lty = 4,axes = FALSE, xlab = \" \", ylab = \" \", main = \" \", col = \"red\", bty = \"n\")\naxis(4)\naxis(1)\n```\n\n::: {.cell-output-display}\n![SNVDT2 and SNVDT2 + First Derivative compared](NIT_tutorial_7_files/figure-html/fig-SNVDT2_SNVDT21der-1.png){#fig-SNVDT2_SNVDT21der width=672}\n:::\n:::\n\n\n## Second derivative\n\nIn the calculation of the second derivative the peak maximum becomes a peak minimum, creating some kind of shoulders on the sides so it is necessary to have this on mind when interpreting the spectra. The resolution of the bands change depending of the values of \"w\" and \"s\" we choose, if the values are lower the resolution increase and at the same time the noise, so it is necessary to find a compromise between this both elements.\n\nNow let´s calculate the second derivative for the raw spectra and for the spectra treated with SNV+DT2 ( we have done this calculation in the previous post).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nder2_spec <- gapDer(absorp, m = 2, w = 5, s = 1, delta.wav = 2)\nsnvdt2der2_spec <- gapDer(tecator$sndt2_spec, m = 2, w = 5, s = 1, delta.wav = 2)\n```\n:::\n\n\nWe have to prepare some code to match the wavelengths due that the derivatives reduce the wavelenth range on both extremes depending of the values of \"w\" and \"s\".\n\n\n::: {.cell}\n\n:::\n\n\n@fig-SNVDT2_2der compares the spectra treated with SNV plus Quadratic Detrend with the spectra of just the second derivative.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmatplot(colnames(tecator$sndt2_spec), t(tecator$sndt2_spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"SNVDT2 vs 2º Der\", col = \"black\", xaxt = \"n\")\npar(new=TRUE)\nmatplot(colnames(der2_spec), t(der2_spec), type = \"l\",lty = 4, axes = FALSE, xlab = \" \", ylab = \" \", main = \" \", col = \"red\", bty = \"n\")\naxis(4)\naxis(1)\n```\n\n::: {.cell-output-display}\n![SNVDT2 and Second derivative compared](NIT_tutorial_7_files/figure-html/fig-SNVDT2_2der-1.png){#fig-SNVDT2_2der width=672}\n:::\n:::\n\n\n@fig-SNVDT2_SNVDT22der compares the spectra treated with SNV plus Quadratic Detrend with the second derivative applied to the SNV+DT2 spectra.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmatplot(colnames(tecator$sndt2_spec), t(tecator$sndt2_spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"SNVDT2 vs SNVDT2 + 2º Der\", col = \"black\", xaxt = \"n\")\npar(new=TRUE)\nmatplot(colnames(snvdt2der2_spec), t(snvdt2der2_spec), type = \"l\",lty = 4, axes = FALSE, xlab = \" \", ylab = \" \", main = \" \", col = \"red\", bty = \"n\")\naxis(4)\naxis(1)\n```\n\n::: {.cell-output-display}\n![SNVDT2 and SNVDT2 + Second Derivative compared](NIT_tutorial_7_files/figure-html/fig-SNVDT2_SNVDT22der-1.png){#fig-SNVDT2_SNVDT22der width=672}\n:::\n:::\n\n\n## Checking the correlation with the protein parameter for the math-treatments calculated in this post\n@fig-correlations1_prot compares correlation spectra for the four different options we have tried in this post. Visually it is difficult to decide which one can be the best, but they can help us to see where are the wavelength ranges more associated to the protein in this case.\n\n::: {.cell}\n\n```{.r .cell-code}\ncor_prot_der1 <- cor(tecator$Protein, der1_spec)\nmatplot(colnames(der1_spec), t(cor_prot_der1), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \" \", col = \"black\", ylim = c(-1.0, 1.0))\npar(new = TRUE)\ncor_prot_snvdt2der1 <- cor(tecator$Protein, snvdt2der1_spec)\nmatplot(colnames(snvdt2der1_spec), t(cor_prot_snvdt2der1), type = \"l\", xlab = \" \", ylab = \" \", main = \" \", col = \"red\", ylim = c(-1.0, 1.0))\npar(new = TRUE)\ncor_prot_der2 <- cor(tecator$Protein, der2_spec)\nmatplot(colnames(der2_spec), t(cor_prot_der2), type = \"l\", xlab = \" \", ylab = \" \", main = \" \", col = \"blue\", ylim = c(-1.0, 1.0))\npar(new = TRUE)\ncor_prot_snvdt2der2 <- cor(tecator$Protein, snvdt2der2_spec)\nmatplot(colnames(snvdt2der2_spec), t(cor_prot_snvdt2der2), type = \"l\", xlab = \" \", ylab = \" \", main = \" \", col = \"green\", ylim = c(-1.0, 1.0))\n\n\nlegend(\"topleft\", legend = c(\"1st Der\", \"SNVDT2+1Der\", \"2nd Der\", \"SNVDT2+2Der\" ),\n       lty = 1, col = c(\"black\", \"red\", \"blue\", \"green\"))\n```\n\n::: {.cell-output-display}\n![SNVDT2 and SNVDT2 + Second Derivative compared](NIT_tutorial_7_files/figure-html/fig-correlations1_prot-1.png){#fig-correlations1_prot width=672}\n:::\n:::\n\n\n::: {.callout-tip collapse=\"true\"}\n## Let´s do it with ggplot2\n\nWe have already load tidyverse library at the beginning\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncor_prot_with_der <- as.data.frame(rbind(cor_prot_der1, cor_prot_snvdt2der1,                                                 cor_prot_der2, cor_prot_snvdt2der2))\n\n#replace all NA values with zero\ncor_prot_with_der <- cor_prot_with_der %>% \n                        replace(is.na(.), 0)\n\ncor_prot_with_dt <- cor_prot_with_der %>% \n  mutate(Mat_treatment = as.factor(c(\"1ª Der\", \"SNVDT2 + 1ª Der\",\n                                     \"2ª Der\", \"SNVDT2 + 2ª Der\")))\n\n\ncor_prot_with_dt %>% \n  pivot_longer(cols = c(1:100), names_to = \"Wavelength\", values_to = \"Correlation\") %>% \n  mutate(Wavelength = as.integer(Wavelength)) %>% \n  ggplot(aes(x = Wavelength, y = Correlation, group = Mat_treatment, col = Mat_treatment)) +\n  geom_line(size = 1)\n```\n\n::: {.cell-output-display}\n![](NIT_tutorial_7_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n:::\n\nLet´s see in a diagram what we have seen until this post\n\n\n```{mermaid}\nflowchart LR\n  A[Raw Spectra] --> B(SNV)\n  A --> C(Detrend only)\n  A --> D[SNV & linear Detrend]\n  A --> E[SNV & Quadratic Detrend]\n  D --> F[First Derivative]\n  D --> G[Second Derivative]\n  A --> H[MSC]\n  A --> I[First Derivative]\n  A --> J[Second Derivative]\n  \n```\n\nWe have several options now to develop models and see which one gives the better statistics, of course there are more math treatments we can try but we stop in this tutorial with the derivatives and in the next ones we will check the different options to find outliers.\n\nFinally we add the new math treatments to the tecator database to use it in the coming posts:\n\n::: {.cell}\n\n```{.r .cell-code}\ntecator$der1_spec <- der1_spec\ntecator$der2_spec <- der2_spec\ntecator$snvdt2der1_spec <- snvdt2der1_spec\ntecator$snvdt2der2_spec <- snvdt2der2_spec\n```\n:::\n\n\nand save the dataframe for future use:\n\n::: {.cell}\n\n```{.r .cell-code}\nsave.image(\"C:/BLOG/Workspaces/NIT Tutorial/NIT_ws7.RData\")\n```\n:::\n",
    "supporting": [
      "NIT_tutorial_7_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}