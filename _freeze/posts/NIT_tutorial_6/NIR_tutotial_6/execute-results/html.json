{
  "hash": "8f8850f0aef77900af4ac64b3005f8ce",
  "result": {
    "markdown": "---\ntitle: \"Near Infrared Transmitance Tutorial (part 6)\"\ndescription: \"The use of linear or quadratic detrend alone or combined with SNV will be treated in this post\"\nimage: Raw_vs_SNVDT1_SNVDT2.jpeg\nauthor: \"José Ramón Cuesta\"\ndate: \"2022-10-14\"\ncategories: [R, NIT Tutorial, Removing scatter, Math-treatments]\n---\n\n\n## Organizing data\n\nFirst we load the work we have done until now:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"C:/BLOG/Workspaces/NIT Tutorial/NIT_ws5.RData\")\nls()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"absorp\"             \"absorp_msc\"         \"absorp_snv\"        \n [4] \"cor_rawspec\"        \"cor_snvspec\"        \"cor_snvspec_fat\"   \n [7] \"cor_snvspec_moi\"    \"cor_snvspec_prot\"   \"endpoints\"         \n[10] \"meats\"              \"meats_longer\"       \"tec_prot_test\"     \n[13] \"tec_prot_test_msc\"  \"tec_prot_train\"     \"tec_prot_train_msc\"\n[16] \"tecator\"            \"tecator_split\"     \n```\n:::\n:::\n\n\nWe can remove some files we have use for some visualization: it is important to maintain the dataframes we will use for the model development with different math treatments and the raw spectra.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(cor_rawspec_fat,cor_rawspec_moi, cor_rawspec_prot,\n   cor_snvspec_fat, cor_snvspec_moi, cor_snvspec_prot)\n```\n:::\n\n\nResuming what we have in th tecator dataframe:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(tecator)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"SampleID\" \"Moisture\" \"Fat\"      \"Protein\"  \"spec\"     \"snv_spec\"\n```\n:::\n:::\n\n\nAs we can see we have the Sample ID, the parameters with the laboratory values for moisture, fat and protein, and the spectra without treatment (raw) and with the SNV treatment. At the moment we take apart the MSC math treatment , we have calculated in the previous post, and keep it for future use.\n\n## DETREND math treatment\n\nWith the detrend we want to remove the linear trend caused normally by the scatter. This shift is no so obvious in the wavelength range we are using in this tutorial, but when using NIR spectra range (1100 - 2500 nm) the shift increase quite a lot and can be linear or quadratic depending on the type of sample or sample presentation. Detrend normally is combined with SNV, and this combination is in the list of some of the commercial software available for NIR or NIT instruments. The math treatments we can see in this post are:\n\n-   Detrend linear only\n\n-   SNV and linear detrend\n\n-   SNV and quadratic detrend\n\n## Detrend only (linear)\n\nWe will use the {pracma} library and the function \"detrend\".\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pracma)\n```\n:::\n\n\nLet´s apply the function to the raw spectra, and see the result:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndt_spec <- pracma::detrend(tecator$spec)\npar(mfrow=c(1, 2))\nmatplot(colnames(tecator$spec), t(tecator$spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"Raw spectra\", col = \"grey\")\nmatplot(colnames(dt_spec), t(dt_spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"Only linear detrend\", col = \"blue\")\n```\n\n::: {.cell-output-display}\n![Raw vs. Detrend only spectra](NIR_tutotial_6_files/figure-html/fig-Raw_DTonly-1.png){#fig-Raw_DTonly width=672}\n:::\n:::\n\n\nin the figure we compare the spectra without any treatment (left) with the spectra with the linear detrend, and we can see how the spectra become flatter due to the trend removal, but the result can be improved with some normalization to remove the baseline shift, so for that reason we use the detrend and SNV combined.\n\n## SNV and linear detrend\n\nIn this case we will use another library {prospectr} , using p = 1 to remove the linear trend.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(prospectr)\nsnvdt1_spec <- prospectr::detrend(tecator$spec, \n                                  wav = as.numeric(colnames(tecator$spec)),\n                                  p = 1) \n```\n:::\n\n\nNow we can compare the result with the raw spectra\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(1, 2))\nmatplot(colnames(tecator$spec), t(tecator$spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"Raw spectra\", col = \"grey\")\nmatplot(colnames(snvdt1_spec), t(snvdt1_spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"SNV and Linear Detrend\", col = \"blue\")\n```\n\n::: {.cell-output-display}\n![Raw vs. SNV+DT1](NIR_tutotial_6_files/figure-html/fig-Raw_SNVDT1-1.png){#fig-Raw_SNVDT1 width=672}\n:::\n:::\n\n\nAs we can see there is an improvement in the result. We can see if the change from p = 1 to p = 2 make some differences:\n\n## SNV and quadratic detrend\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsnvdt2_spec <- prospectr::detrend(tecator$spec, \n                                  wav = as.numeric(colnames(tecator$spec)),\n                                  p = 2) \n```\n:::\n\n\nNow we can compare the result with the raw spectra and linear detrend spectra.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(1, 3))\nmatplot(colnames(tecator$spec), t(tecator$spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"Raw spectra\", col = \"grey\")\nmatplot(colnames(snvdt1_spec), t(snvdt1_spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"SNV and Linear Detrend\", col = \"blue\")\nmatplot(colnames(snvdt2_spec), t(snvdt2_spec), type = \"l\", xlab = \"wavelengths (nm)\", ylab = \"Absorbance\", main = \"SNV and Quadratic Detrend\", col = \"blue\")\n```\n\n::: {.cell-output-display}\n![Raw vs. SNV+DT1 and SNV+DT2](NIR_tutotial_6_files/figure-html/fig-Raw_SNVDT2-1.png){#fig-Raw_SNVDT2 width=672}\n:::\n:::\n\n\n## Detrend correlations with Protein depending on type\n\nLet´s check the correlations for the different math treatment combinations using detrend to get some conclusions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncor_prot_dt <- cor(tecator$Protein, dt_spec)\ncor_prot_snvdt1 <- cor(tecator$Protein, snvdt1_spec)\ncor_prot_snvdt2 <- cor(tecator$Protein, snvdt2_spec)\n\ncor_prot_with_dt <- as.data.frame(rbind(cor_prot_dt, cor_prot_snvdt1, cor_prot_snvdt2))\n\nlibrary(tidyverse)\n\ncor_prot_with_dt <- cor_prot_with_dt %>% \n  mutate(Mat_treatment = as.factor(c(\"DT\", \"SNV+DT1\", \"SNV+DT2\")))\n\n\ncor_prot_with_dt %>% \n  pivot_longer(cols = c(1:100), names_to = \"Wavelength\", values_to = \"Correlation\") %>% \n  mutate(Wavelength = as.integer(Wavelength)) %>% \n  ggplot(aes(x = Wavelength, y = Correlation, group = Mat_treatment, col = Mat_treatment)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![Wavelength correlation with protein for the different Detrend treatments](NIR_tutotial_6_files/figure-html/fig-Proteincor_dts-1.png){#fig-Proteincor_dts width=672}\n:::\n:::\n\n\nAs we can see it seems that there are an improvement in the correlation when using Quadratic Detrend combined with SNV. Anyway we wiil see during the models developments if the statistics confirm this.\n\nWe can add all these three new math-treatments to the tecator dataframe for future use:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntecator$dt_spec <- dt_spec\ntecator$snvdt1_spec <- snvdt1_spec\ntecator$sndt2_spec <- snvdt2_spec\n```\n:::\n\n\nLet´s save the workspace\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsave.image(\"C:/BLOG/Workspaces/NIT Tutorial/NIT_ws6.RData\")\n```\n:::\n",
    "supporting": [
      "NIR_tutotial_6_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}